# Sécurité et configuration Apache
# ================================

# Activer la réécriture d'URL
RewriteEngine On

# Forcer HTTPS (décommenter en production)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ================================
# URLs propres sans .php
# ================================

# Exclure le dossier API des règles de réécriture
RewriteRule ^api/ - [L]

# Exclure le dossier assets des règles de réécriture
RewriteRule ^assets/ - [L]

# Ne pas appliquer aux fichiers/dossiers existants
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Rediriger les URLs sans .php vers le fichier .php (seulement si le .php existe)
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/assets/
RewriteCond %{DOCUMENT_ROOT}/$1.php -f
RewriteRule ^([^/]+)/?$ $1.php [L,QSA]

# Rediriger les URLs admin sans .php (seulement si le .php existe)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/admin/$1.php -f
RewriteRule ^admin/([^/]+)/?$ admin/$1.php [L,QSA]

# Rediriger les URLs client sans .php (seulement si le .php existe)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/client/$1.php -f
RewriteRule ^client/([^/]+)/?$ client/$1.php [L,QSA]

# Redirection 301 des anciennes URLs .php vers les nouvelles (SEO)
# Exclure l'API de la redirection
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{THE_REQUEST} ^[A-Z]{3,}\s/+([^.]+)\.php(\?[^\s]*)?\s [NC]
RewriteRule ^ /%1 [R=301,L]

# ================================
# Pages d'erreur personnalisées
# ================================
ErrorDocument 400 /error.php
ErrorDocument 403 /error.php
ErrorDocument 404 /error.php
ErrorDocument 500 /error.php
ErrorDocument 503 /error.php

# ================================

# Protéger les fichiers sensibles
<FilesMatch "^(config\.php|install\.sql)$">
    Require all denied
</FilesMatch>

# Protéger le dossier classes
<IfModule mod_rewrite.c>
    RewriteRule ^classes/ - [F,L]
    RewriteRule ^logs/ - [F,L]
</IfModule>

# Désactiver l'affichage du contenu des répertoires
Options -Indexes

# Protection contre le hotlinking (optionnel)
# RewriteCond %{HTTP_REFERER} !^$
# RewriteCond %{HTTP_REFERER} !^https?://(www\.)?votredomaine\.com [NC]
# RewriteRule \.(js|css)$ - [F]

# Headers de sécurité
<IfModule mod_headers.c>
    # Protection XSS
    Header set X-XSS-Protection "1; mode=block"

    # Empêcher le sniffing MIME
    Header set X-Content-Type-Options "nosniff"

    # Protection contre le clickjacking
    Header set X-Frame-Options "SAMEORIGIN"

    # Politique de référent
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Compression GZIP
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/css application/json
    AddOutputFilterByType DEFLATE application/javascript text/xml application/xml
</IfModule>

# Cache des ressources statiques
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
</IfModule>

# Charset UTF-8
AddDefaultCharset UTF-8

# PHP Settings (désactivé - peut causer erreur 500 sur PHP-FPM)
# Si nécessaire, configurer via php.ini ou le panneau d'hébergement
# <IfModule mod_php.c>
#     php_value upload_max_filesize 10M
#     php_value post_max_size 10M
#     php_value max_execution_time 60
#     php_flag display_errors off
#     php_flag log_errors on
# </IfModule>
